const SHEET_NAME = 'PoolData';
const ADMIN_CODE = 'sblx2026';

function doGet(e) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const data = getData();
    return sendJson(data);
  } finally {
    lock.releaseLock();
  }
}

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const payload = JSON.parse(e.postData.contents);
    const data = getData();

    switch (payload.action) {
      case 'submit_entry': {
        if (data.locked) return sendJson({ error: 'locked', ...data });
        const dup = data.entries.find(
          x => x.name.toLowerCase() === payload.entry.name.toLowerCase()
        );
        if (dup) return sendJson({ error: 'name_taken', existing: dup, ...data });
        data.entries.push(payload.entry);
        break;
      }
      case 'toggle_result': {
        if (payload.adminCode !== ADMIN_CODE) return sendJson({ error: 'bad_code' });
        if (data.results[payload.betId]) delete data.results[payload.betId];
        else data.results[payload.betId] = true;
        break;
      }
      case 'toggle_lock': {
        if (payload.adminCode !== ADMIN_CODE) return sendJson({ error: 'bad_code' });
        data.locked = !data.locked;
        break;
      }
      case 'post_update': {
        return sendJson(handlePostUpdate(payload));
      }
      case 'post_reply': {
        return sendJson(handlePostReply(payload));
      }
    }

    saveData(data);
    return sendJson(data);
  } finally {
    lock.releaseLock();
  }
}

function getData() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const val = sheet.getRange('A1').getValue();
  if (!val) return { entries: [], results: {}, locked: false, updates: getUpdates() };
  try { 
    const data = JSON.parse(val);
    return { ...data, updates: getUpdates() }; 
  } catch (e) { 
    return { entries: [], results: {}, locked: false, updates: getUpdates() }; 
  }
}

function saveData(data) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  sheet.getRange('A1').setValue(JSON.stringify(data));
}

function sendJson(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function getUpdates() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const updSheet = ss.getSheetByName('Updates');
  const repSheet = ss.getSheetByName('Replies');
  if (!updSheet) return [];

  const updData = updSheet.getDataRange().getValues();
  const repData = repSheet ? repSheet.getDataRange().getValues() : [];
  const updates = [];

  for (let i = 1; i < updData.length; i++) {
    const row = updData[i];
    if (!row[0]) continue;
    const upd = {
      id: String(row[0]),
      message: String(row[1]),
      timestamp: String(row[2])
    };
    upd.replies = [];
    for (let j = 1; j < repData.length; j++) {
      if (String(repData[j][0]) === upd.id) {
        upd.replies.push({
          name: String(repData[j][1]),
          text: String(repData[j][2]),
          timestamp: String(repData[j][3])
        });
      }
    }
    updates.push(upd);
  }

  updates.reverse();
  return updates;
}

function handlePostUpdate(data) {
  if (data.adminCode !== ADMIN_CODE) return { error: 'unauthorized' };

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let updSheet = ss.getSheetByName('Updates');
  if (!updSheet) {
    updSheet = ss.insertSheet('Updates');
    updSheet.appendRow(['id', 'message', 'timestamp']);
  }

  const id = 'u' + Date.now();
  updSheet.appendRow([id, data.message, new Date().toISOString()]);

  return getData();
}

function handlePostReply(data) {
  if (!data.updateId || !data.name || !data.text) return { error: 'missing_fields' };
  if (data.name.length > 30) return { error: 'name_too_long' };
  if (data.text.length > 280) return { error: 'text_too_long' };

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let repSheet = ss.getSheetByName('Replies');
  if (!repSheet) {
    repSheet = ss.insertSheet('Replies');
    repSheet.appendRow(['updateId', 'name', 'text', 'timestamp']);
  }

  repSheet.appendRow([data.updateId, data.name, data.text, new Date().toISOString()]);

  return getData();
}