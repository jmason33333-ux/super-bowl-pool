const SHEET_NAME = 'PoolData';
const ADMIN_CODE = 'sblx2026';

function doGet(e) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const data = getData();
    return sendJson(data);
  } finally {
    lock.releaseLock();
  }
}

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const payload = JSON.parse(e.postData.contents);
    const data = getData();

    switch (payload.action) {
      case 'submit_entry': {
        if (data.locked) return sendJson({ error: 'locked', ...data });
        const dup = data.entries.find(
          x => x.name.toLowerCase() === payload.entry.name.toLowerCase()
        );
        if (dup) return sendJson({ error: 'name_taken', existing: dup, ...data });
        data.entries.push(payload.entry);
        break;
      }
      case 'toggle_result': {
        if (payload.adminCode !== ADMIN_CODE) return sendJson({ error: 'bad_code' });
        if (data.results[payload.betId]) delete data.results[payload.betId];
        else data.results[payload.betId] = true;
        break;
      }
      case 'toggle_lock': {
        if (payload.adminCode !== ADMIN_CODE) return sendJson({ error: 'bad_code' });
        data.locked = !data.locked;
        break;
      }
    }

    saveData(data);
    return sendJson(data);
  } finally {
    lock.releaseLock();
  }
}

function getData() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const val = sheet.getRange('A1').getValue();
  if (!val) return { entries: [], results: {}, locked: false };
  try { return JSON.parse(val); } catch (e) { return { entries: [], results: {}, locked: false }; }
}

function saveData(data) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  sheet.getRange('A1').setValue(JSON.stringify(data));
}

function sendJson(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
